<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>sychronized关键字详解 | Java 全栈知识体系</title>
    <meta name="description" content="包含: Java 基础, Java 部分源码, JVM, Spring, Spring Boot, Spring Cloud, 数据库原理, MySQL, ElasticSearch, MongoDB, Docker, k8s, CI&amp;CD, Linux, DevOps, 分布式, 中间件, 开发工具, Git, IDE, 源码阅读，读书笔记, 开源项目...">
    <link rel="icon" href="/images/photo.jpg">
  <link rel="manifest" href="/images/photo.jpg">
  <link rel="apple-touch-icon" href="/images/photo.jpg">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.6aaa91c1.css" as="style"><link rel="preload" href="/assets/js/app.c0473f8a.js" as="script"><link rel="preload" href="/assets/js/7.d6a8f10f.js" as="script"><link rel="prefetch" href="/assets/js/10.18d86387.js"><link rel="prefetch" href="/assets/js/11.66cfeecb.js"><link rel="prefetch" href="/assets/js/12.cd8d3d1a.js"><link rel="prefetch" href="/assets/js/13.b7a0d653.js"><link rel="prefetch" href="/assets/js/14.1b6a79b6.js"><link rel="prefetch" href="/assets/js/15.c0ad90a0.js"><link rel="prefetch" href="/assets/js/16.21dd4be2.js"><link rel="prefetch" href="/assets/js/17.2f89b4b4.js"><link rel="prefetch" href="/assets/js/18.46ea7848.js"><link rel="prefetch" href="/assets/js/19.12f845cd.js"><link rel="prefetch" href="/assets/js/2.20434474.js"><link rel="prefetch" href="/assets/js/20.0b07a6df.js"><link rel="prefetch" href="/assets/js/21.10c4ca9a.js"><link rel="prefetch" href="/assets/js/22.6c080e66.js"><link rel="prefetch" href="/assets/js/23.7cf8bbaa.js"><link rel="prefetch" href="/assets/js/24.9ebb37ca.js"><link rel="prefetch" href="/assets/js/25.f68c1a55.js"><link rel="prefetch" href="/assets/js/26.b9df2f10.js"><link rel="prefetch" href="/assets/js/27.18f247d9.js"><link rel="prefetch" href="/assets/js/28.432433f3.js"><link rel="prefetch" href="/assets/js/29.1629c5f7.js"><link rel="prefetch" href="/assets/js/3.0825c95b.js"><link rel="prefetch" href="/assets/js/30.7aedcf73.js"><link rel="prefetch" href="/assets/js/31.2584afee.js"><link rel="prefetch" href="/assets/js/32.b6a772de.js"><link rel="prefetch" href="/assets/js/33.d1c11cc7.js"><link rel="prefetch" href="/assets/js/34.a9489ced.js"><link rel="prefetch" href="/assets/js/35.762fe385.js"><link rel="prefetch" href="/assets/js/36.2a12696c.js"><link rel="prefetch" href="/assets/js/37.a486ffa2.js"><link rel="prefetch" href="/assets/js/38.4a4d259e.js"><link rel="prefetch" href="/assets/js/39.725f21cc.js"><link rel="prefetch" href="/assets/js/4.07a82219.js"><link rel="prefetch" href="/assets/js/40.81274669.js"><link rel="prefetch" href="/assets/js/41.26390452.js"><link rel="prefetch" href="/assets/js/42.9315c35d.js"><link rel="prefetch" href="/assets/js/43.0af18675.js"><link rel="prefetch" href="/assets/js/44.abbecb02.js"><link rel="prefetch" href="/assets/js/45.0cce3436.js"><link rel="prefetch" href="/assets/js/5.5eab205c.js"><link rel="prefetch" href="/assets/js/6.ce6e87d0.js"><link rel="prefetch" href="/assets/js/8.22479811.js"><link rel="prefetch" href="/assets/js/9.b544e193.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6aaa91c1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Java 全栈知识体系</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/md/" class="nav-link router-link-active">导读</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/JAVA/" class="nav-link router-link-active">JAVA基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算机网络</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/计算机网络/图解网络.html" class="nav-link">图解网络</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">项目部署</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/DevOps/Docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/md/DevOps/Linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/md/DevOps/blog/" class="nav-link">个人博客</a></li></ul></div></div> <a href="https://github.com/caizongkai/vuepressDemo" target="_blank" rel="noopener noreferrer" class="repo-link">
    修改文档
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/md/" class="nav-link router-link-active">导读</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/JAVA/" class="nav-link router-link-active">JAVA基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算机网络</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/计算机网络/图解网络.html" class="nav-link">图解网络</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">项目部署</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/DevOps/Docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/md/DevOps/Linux/" class="nav-link">Linux</a></li><li class="dropdown-item"><!----> <a href="/md/DevOps/blog/" class="nav-link">个人博客</a></li></ul></div></div> <a href="https://github.com/caizongkai/vuepressDemo" target="_blank" rel="noopener noreferrer" class="repo-link">
    修改文档
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>JAVA基础知识</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/md/JAVA/java-base/反射.html" class="sidebar-link">反射</a></li><li><a href="/md/JAVA/java-base/泛型.html" class="sidebar-link">泛型</a></li><li><a href="/md/JAVA/java-base/注解.html" class="sidebar-link">注解</a></li><li><a href="/md/JAVA/java-base/面向对象.html" class="sidebar-link">面向对象</a></li><li><a href="/md/JAVA/java-base/异常/异常.html" class="sidebar-link">异常</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>多线程</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/md/JAVA/多线程/多线程-01-多线程基础知识.html" class="sidebar-link">多线程基础知识</a></li><li><a href="/md/JAVA/多线程/多线程-02-Java并发-理论基础.html" class="sidebar-link">Java并发-理论基础</a></li><li><a href="/md/JAVA/多线程/多线程-03-Java并发-线程基础.html" class="sidebar-link">Java并发-线程基础</a></li><li><a href="/md/JAVA/多线程/多线程-04-sychronized关键字.html" class="active sidebar-link">sychronized关键字</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/JAVA/多线程/多线程-04-sychronized关键字.html#synchronized锁的使用" class="sidebar-link">Synchronized锁的使用</a></li><li class="sidebar-sub-header"><a href="/md/JAVA/多线程/多线程-04-sychronized关键字.html#synchronized加锁、释放锁原理" class="sidebar-link">Synchronized加锁、释放锁原理</a></li><li class="sidebar-sub-header"><a href="/md/JAVA/多线程/多线程-04-sychronized关键字.html#jvm的锁优化" class="sidebar-link">JVM的锁优化</a></li><li class="sidebar-sub-header"><a href="/md/JAVA/多线程/多线程-04-sychronized关键字.html#再深入理解" class="sidebar-link">再深入理解</a></li><li class="sidebar-sub-header"><a href="/md/JAVA/多线程/多线程-04-sychronized关键字.html#synchronized和lock的对比" class="sidebar-link">synchronized和Lock的对比</a></li></ul></li><li><a href="/md/JAVA/多线程/多线程-05-final关键字.html" class="sidebar-link">final关键字</a></li><li><a href="/md/JAVA/多线程/多线程-06-volatile关键字.html" class="sidebar-link">volatile关键字</a></li><li><a href="/md/JAVA/多线程/多线程-07-JUC原子类-CAS和Unsafe.html" class="sidebar-link">JUC原子类-CAS和Unsafe</a></li><li><a href="/md/JAVA/多线程/多线程-08-JUC锁-LockSupport.html" class="sidebar-link">JUC锁-LockSupport</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>集合</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/md/JAVA/集合/集合.html" class="sidebar-link">集合</a></li><li><a href="/md/JAVA/集合/HashMap.html" class="sidebar-link">HashMap</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="sychronized关键字详解"><a href="#sychronized关键字详解" class="header-anchor">#</a> sychronized关键字详解</h1> <p>[TOC]</p> <blockquote><p>带着问题学知识</p></blockquote> <ul><li><p>Synchronized可以作用在哪里? 分别通过对象锁和类锁进行举例。</p></li> <li><p>Synchronized本质上是通过什么保证线程安全的? 分三个方面回答：加锁和释放锁的原理，可重入原理，保证可见性原理。</p></li> <li><p>Synchronized有什么样的缺陷?  Java Lock是怎么弥补这些缺陷的。</p></li> <li><p>Synchronized和Lock的对比，和选择?</p></li> <li><p>Synchronized在使用时有何注意事项?</p></li> <li><p>Synchronized修饰的方法在抛出异常时,会释放锁吗?</p></li> <li><p>多个线程等待同一个snchronized锁的时候，JVM如何选择下一个获取锁的线程?</p></li> <li><p>Synchronized使得同时只有一个线程可以执行，性能比较差，有什么提升的方法?</p></li> <li><p>我想更加灵活地控制锁的释放和获取(现在释放锁和获取锁的时机都被规定死了)，怎么办?</p></li> <li><p>什么是锁的升级和降级? 什么是JVM里的偏斜锁、轻量级锁、重量级锁?</p></li> <li><p>不同的JDK中对Synchronized有何优化?</p></li></ul> <h2 id="synchronized锁的使用"><a href="#synchronized锁的使用" class="header-anchor">#</a> Synchronized锁的使用</h2> <p>synchronized锁可以分为对象锁，类锁。一个synchronized锁只能由一个线程获得，其他没有获得的线程只能等待；</p> <h3 id="对象锁"><a href="#对象锁" class="header-anchor">#</a> 对象锁</h3> <p>使用对象锁有两种方式</p> <ol><li>在普通方法上加锁</li> <li>在代码块上加锁，可以给当前对象this加锁，也可以自定义锁</li></ol> <p>以下是代码实现：</p> <p>在普通方法上加锁：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我是线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>在代码块上加锁，锁对象是this:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedObjectLock</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">SynchronizedObjectLock</span> instence <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedObjectLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 同步代码块形式——锁为this,两个线程使用的锁是一样的,线程1必须要等到线程0释放了该锁后，才能执行</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我是线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>在代码块上加锁，并且自定义锁对象：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedObjectLock</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token class-name">SynchronizedObjectLock</span> instence <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SynchronizedObjectLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建2把锁</span>
    <span class="token class-name">Object</span> block1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Object</span> block2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这个代码块使用的是第一把锁，当他释放后，后面的代码块由于使用的是第二把锁，因此可以马上执行</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>block1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;block1锁,我是线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;block1锁,&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>block2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;block2锁,我是线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;block2锁,&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> t1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> t2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>instence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="类锁"><a href="#类锁" class="header-anchor">#</a> 类锁</h3> <p>类锁的加锁形式有两种：</p> <ol><li>在静态方法上加关键字synchronized</li> <li>在方法块上加锁，并且锁对象是当前Class</li></ol> <p>以下是代码实现：</p> <p>在静态方法上加关键字synchronized：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>   <span class="token comment">// synchronized用在静态方法上，默认的锁就是当前所在的Class类，所以无论是哪个线程访问它，需要的锁都只有一把</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我是线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在方法块上加锁，并且锁对象是当前Class:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
 <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token class-name">SynchronizedObjectLock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
     <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;我是线程&quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="synchronized加锁、释放锁原理"><a href="#synchronized加锁、释放锁原理" class="header-anchor">#</a> Synchronized加锁、释放锁原理</h2> <p>线程获取锁时会去获取monitor，当monitor计数器为0的时候表示没有线程进入该锁，否则表示已经有线程在该锁里面，此时线程进入等待状态。</p> <p>当线程成功获取monitor，且monitor为0时，线程会执行monitorenter指令进入锁，monitor计数器会+1，如果线程拿到了monitor的所有权，并且重入了这把锁，那么monitor的计数器的值会+1，(注意:此时线程不需要执行monitorenter指令)，如果一直重入会一直累加。当锁定的代码执行完毕之后，monitor会-1，如果-1之后monitor的值变为0，那么线程会执行monitorexit指令，释放锁。</p> <p>任意线程对Object的访问，首先要获得Object的监视器，如果获取失败，该线程就进入同步状态，线程状态变为BLOCKED，当Object的监视器占有者释放后，在同步队列中得线程就会有机会重新获取该监视器。</p> <h2 id="jvm的锁优化"><a href="#jvm的锁优化" class="header-anchor">#</a> JVM的锁优化</h2> <p>因为JVM每次执行monitorenter和monitorexit指令都得将线程挂起，并从用户态切换到内核态，所以如果每次操作都采用这种方式，将会对操作系统造成很大的压力，所以JVM对锁机制进行了优化。JVM采用了锁粗化，锁消除，偏向锁，适应性自旋锁，轻量级锁，重量级锁等技术对锁进行优化。</p> <blockquote><p>锁的膨胀</p> <p>在Java SE 1.6里Synchronied同步锁，一共有四种状态：<code>无锁</code>、<code>偏向锁</code>、<code>轻量级锁</code>、<code>重量级锁</code>，它会随着竞争情况逐渐升级。锁可以升级但是不可以降级，目的是为了提供获取锁和释放锁的效率。</p> <p>锁膨胀方向： 无锁 → 偏向锁 → 轻量级锁 → 重量级锁 (此过程是不可逆的)</p></blockquote> <h3 id="锁的类型："><a href="#锁的类型：" class="header-anchor">#</a> 锁的类型：</h3> <h4 id="cas操作（偏向锁和轻量级锁用到了该操作）"><a href="#cas操作（偏向锁和轻量级锁用到了该操作）" class="header-anchor">#</a> CAS操作（偏向锁和轻量级锁用到了该操作）</h4> <p>CAS操作需要输入两个数值，一个旧值(原值)和一个新值，在操作期间先比较旧值有没有发生变化，如果没有发生变化，才交换成新值，发生了变化则不交换。</p> <p>CAS操作经常会多添加一个version字段，表示版本号。</p> <p>主要解决变量发生A→B→A而CAS却不知情的问题。（<strong>ABA问题</strong>）</p> <p>追加版本号之后，变量的修改操作就变为了1A→2B→3A。</p> <h4 id="锁粗化"><a href="#锁粗化" class="header-anchor">#</a> 锁粗化</h4> <p>在加同步锁时，我们尽可能的把锁范围缩小，但如果对同一个对象反复加锁跟解锁，那么会造成性能消耗，所以JVM对该情况做了锁粗化，将锁的范围扩大到这一系列对同一对象进行操作的外部。</p> <h4 id="锁消除"><a href="#锁消除" class="header-anchor">#</a> 锁消除</h4> <p>由于加锁是因为共享变量在不同线程之间可能会出现可见性问题，所以当JVM检测到该数据并不需要共享，不可能逃逸出去，那么JVM就会进行锁消除。</p> <h4 id="自旋锁"><a href="#自旋锁" class="header-anchor">#</a> 自旋锁</h4> <p>由于我们前面说过对线程的阻塞操作需要将线程挂起，并从用户态切换到内核态才能实现，但是这个操作对操作系统来说会造成非常大的压力，所以JDK1.4的时候引入了自旋锁，自旋锁是指当线程在获取数据的时候发现该数据加锁了，那么线程会自旋（也称自循环），就不用将线程挂起频繁切换，降低了操作系统的压力，但是会浪费CPU的资源。默认的自旋次数是10。</p> <h4 id="适应性自旋锁"><a href="#适应性自旋锁" class="header-anchor">#</a> 适应性自旋锁</h4> <p>在JDK1.6，引入了<strong>自适应自旋锁</strong>，也就是说线程在获取锁的过程中，如果该锁在上次线程自旋等待过程中能顺利获取到锁，那么JVM会判定该锁采用线程自旋的方式获取到的几率比较高，那么JVM会把自旋次数调高，比如说100，但是当上次自旋等待没有顺利获取到锁，那么JVM会降低自旋次数甚至不进行自旋直接是使线程进入阻塞状态。</p> <h4 id="偏向锁"><a href="#偏向锁" class="header-anchor">#</a> 偏向锁</h4> <p>有可能一个锁只会被一个线程访问，那么频繁地获取锁跟释放锁将带来线程的消耗。这个时候偏向锁就出现了。当锁实例化后第一次被获取，那么有可能该锁只会被一个线程获取，此时会使用CAS操作将锁对象对象头的Mark Word中的ThreadId改为自己的id，下次该线程对该锁进行操作时，就不需要获取和释放锁。</p> <p>当第二个线程去获取该锁时，会判断锁偏向的那个线程是否死亡，如果那个线程死亡了，那么会撤销锁对前一个线程的偏向，并用CAS操作将锁的ThreadId改为第二个线程的线程id。如果第一个线程没有消亡，那么偏向锁会升级为轻量级锁。</p> <h4 id="轻量级锁"><a href="#轻量级锁" class="header-anchor">#</a> 轻量级锁</h4> <p>轻量级锁的原理是：会先在线程的栈帧中开辟一个Lock Record（锁记录）空间，来记录锁对象的Mark Word，Mark Word中存在hascode,CG Age以及锁标志位等信息。</p> <p>当Lock Record空间被开辟完之后，使用CAS操作将Mark Word信息复制到Lock Record，叫做Display Mark Word，然后使用CAS操作将Mark Word修改为指向Display Mark Word的指针，如果该操作成功了，那么就代表该线程拥有该锁，将Mark Word的锁标志位改为‘00’，如果这个更新操作失败，JVM会检查当前的<code>Mark Word</code>中是否存在指向当前线程的栈帧的指针，如果有，说明该锁已经被获取，可以直接调用。如果没有，则说明该锁被其他线程抢占了，如果有两条以上的线程竞争同一个锁，那轻量级锁就不再有效，直接膨胀位重量级锁，没有获得锁的线程会被阻塞。此时，锁的标志位为10。</p> <p><img src="/assets/img/image-20201224210419610.56853a13.png" alt="image-20201224210419610"></p> <p>当轻量级锁释放锁的时候，会将Display Mark Word使用CAS操作写回Mark Work，如果该操作成功，那么表示没有发生竞争关系，如果失败，则说明发生竞争关系，该锁需要膨胀为重量级锁，没有获取锁的线程将会被阻塞。</p> <p><em><strong>轻量锁膨胀到重量锁有两个条件</strong></em></p> <p>1.等待的线程自旋超过一定次数。</p> <p>2.持有锁的线程CAS释放锁，但是失败。</p> <p>下图是锁膨胀的关系图：</p> <p><img src="/assets/img/image-20201224210849732.c351127b.png" alt="image-20201224210849732"></p> <h3 id="锁的优缺点对比"><a href="#锁的优缺点对比" class="header-anchor">#</a> 锁的优缺点对比</h3> <table><thead><tr><th>锁</th> <th>优点</th> <th>缺点</th> <th>使用场景</th></tr></thead> <tbody><tr><td>偏向锁</td> <td>不需要重复获取和释放锁</td> <td>如果线程间存在锁竞争，会带来额外的锁撤销的消耗</td> <td>适用于只有一个线程访问同步快的场景</td></tr> <tr><td>轻量级锁</td> <td>竞争的线程不会阻塞，提高了响应速度</td> <td>如线程成始终得不到锁竞争的线程，使用自旋会消耗CPU性能</td> <td>追求响应时间，同步快执行速度非常快</td></tr> <tr><td>重量级锁</td> <td>线程竞争不用自旋，不会消耗CPU</td> <td>线程阻塞，响应时间缓慢，在多线程下，频繁的获取释放锁，会带来巨大的性能消耗</td> <td>追求吞吐量，同步快执行速度较长</td></tr></tbody></table> <h2 id="再深入理解"><a href="#再深入理解" class="header-anchor">#</a> 再深入理解</h2> <p>synchronized是通过软件(JVM)实现的，简单易用，即使在JDK5之后有了Lock，仍然被广泛地使用。</p> <ul><li><strong>使用Synchronized有哪些要注意的？</strong> <ul><li>锁对象不能为空，因为锁的信息都保存在对象头里</li> <li>作用域不宜过大，影响程序执行的速度，控制范围过大，编写代码也容易出错</li> <li>避免死锁</li> <li>在能选择的情况下，既不要用Lock也不要用synchronized关键字，用java.util.concurrent包中的各种各样的类，如果不用该包下的类，在满足业务的情况下，可以使用synchronized关键字，因为代码量少，避免出错</li></ul></li> <li><strong>synchronized是公平锁吗？</strong></li></ul> <p>synchronized实际上是非公平的，新来的线程有可能立即获得监视器，而在等待区中等候已久的线程可能再次等待，不过这种抢占的方式可以预防饥饿。</p> <h2 id="synchronized和lock的对比"><a href="#synchronized和lock的对比" class="header-anchor">#</a> synchronized和Lock的对比</h2> <p>//TODO（了解Lock）</p> <h1 id="参考文章："><a href="#参考文章：" class="header-anchor">#</a> 参考文章：</h1> <ul><li>https://www.cnblogs.com/cangqiongbingchen/p/11009844.html</li> <li>https://www.pdai.tech/md/java/thread/java-thread-x-key-synchronized.html</li></ul></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/caizongkai/vuepressDemo/edit/main/docs/md/JAVA/多线程/多线程-04-sychronized关键字.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.c0473f8a.js" defer></script><script src="/assets/js/7.d6a8f10f.js" defer></script>
  </body>
</html>
