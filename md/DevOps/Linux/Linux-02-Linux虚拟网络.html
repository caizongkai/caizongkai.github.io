<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Linux虚拟网络技术 | Java 全栈知识体系</title>
    <meta name="description" content="包含: Java 基础, Java 部分源码, JVM, Spring, Spring Boot, Spring Cloud, 数据库原理, MySQL, ElasticSearch, MongoDB, Docker, k8s, CI&amp;CD, Linux, DevOps, 分布式, 中间件, 开发工具, Git, IDE, 源码阅读，读书笔记, 开源项目...">
    <link rel="icon" href="/images/photo.jpg">
  <link rel="manifest" href="/images/photo.jpg">
  <link rel="apple-touch-icon" href="/images/photo.jpg">
  <meta http-quiv="pragma" cotent="no-cache">
  <meta http-quiv="pragma" cotent="no-cache,must-revalidate">
  <meta http-quiv="expires" cotent="0">
    
    <link rel="preload" href="/assets/css/0.styles.6aaa91c1.css" as="style"><link rel="preload" href="/assets/js/app.c0473f8a.js" as="script"><link rel="preload" href="/assets/js/5.5eab205c.js" as="script"><link rel="prefetch" href="/assets/js/10.18d86387.js"><link rel="prefetch" href="/assets/js/11.66cfeecb.js"><link rel="prefetch" href="/assets/js/12.cd8d3d1a.js"><link rel="prefetch" href="/assets/js/13.b7a0d653.js"><link rel="prefetch" href="/assets/js/14.1b6a79b6.js"><link rel="prefetch" href="/assets/js/15.c0ad90a0.js"><link rel="prefetch" href="/assets/js/16.21dd4be2.js"><link rel="prefetch" href="/assets/js/17.2f89b4b4.js"><link rel="prefetch" href="/assets/js/18.46ea7848.js"><link rel="prefetch" href="/assets/js/19.12f845cd.js"><link rel="prefetch" href="/assets/js/2.20434474.js"><link rel="prefetch" href="/assets/js/20.0b07a6df.js"><link rel="prefetch" href="/assets/js/21.10c4ca9a.js"><link rel="prefetch" href="/assets/js/22.6c080e66.js"><link rel="prefetch" href="/assets/js/23.7cf8bbaa.js"><link rel="prefetch" href="/assets/js/24.9ebb37ca.js"><link rel="prefetch" href="/assets/js/25.f68c1a55.js"><link rel="prefetch" href="/assets/js/26.b9df2f10.js"><link rel="prefetch" href="/assets/js/27.18f247d9.js"><link rel="prefetch" href="/assets/js/28.432433f3.js"><link rel="prefetch" href="/assets/js/29.1629c5f7.js"><link rel="prefetch" href="/assets/js/3.0825c95b.js"><link rel="prefetch" href="/assets/js/30.7aedcf73.js"><link rel="prefetch" href="/assets/js/31.2584afee.js"><link rel="prefetch" href="/assets/js/32.b6a772de.js"><link rel="prefetch" href="/assets/js/33.d1c11cc7.js"><link rel="prefetch" href="/assets/js/34.a9489ced.js"><link rel="prefetch" href="/assets/js/35.762fe385.js"><link rel="prefetch" href="/assets/js/36.2a12696c.js"><link rel="prefetch" href="/assets/js/37.a486ffa2.js"><link rel="prefetch" href="/assets/js/38.4a4d259e.js"><link rel="prefetch" href="/assets/js/39.725f21cc.js"><link rel="prefetch" href="/assets/js/4.07a82219.js"><link rel="prefetch" href="/assets/js/40.81274669.js"><link rel="prefetch" href="/assets/js/41.26390452.js"><link rel="prefetch" href="/assets/js/42.9315c35d.js"><link rel="prefetch" href="/assets/js/43.0af18675.js"><link rel="prefetch" href="/assets/js/44.abbecb02.js"><link rel="prefetch" href="/assets/js/45.0cce3436.js"><link rel="prefetch" href="/assets/js/6.ce6e87d0.js"><link rel="prefetch" href="/assets/js/7.d6a8f10f.js"><link rel="prefetch" href="/assets/js/8.22479811.js"><link rel="prefetch" href="/assets/js/9.b544e193.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6aaa91c1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Java 全栈知识体系</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/md/" class="nav-link router-link-active">导读</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/JAVA/" class="nav-link">JAVA基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算机网络</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/计算机网络/图解网络.html" class="nav-link">图解网络</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">项目部署</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/DevOps/Docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/md/DevOps/Linux/" class="nav-link router-link-active">Linux</a></li><li class="dropdown-item"><!----> <a href="/md/DevOps/blog/" class="nav-link">个人博客</a></li></ul></div></div> <a href="https://github.com/caizongkai/vuepressDemo" target="_blank" rel="noopener noreferrer" class="repo-link">
    修改文档
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/md/" class="nav-link router-link-active">导读</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/JAVA/" class="nav-link">JAVA基础</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">计算机网络</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/计算机网络/图解网络.html" class="nav-link">图解网络</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">项目部署</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/md/DevOps/Docker/" class="nav-link">Docker</a></li><li class="dropdown-item"><!----> <a href="/md/DevOps/Linux/" class="nav-link router-link-active">Linux</a></li><li class="dropdown-item"><!----> <a href="/md/DevOps/blog/" class="nav-link">个人博客</a></li></ul></div></div> <a href="https://github.com/caizongkai/vuepressDemo" target="_blank" rel="noopener noreferrer" class="repo-link">
    修改文档
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Linux</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/md/DevOps/Linux/Linux-01-Linux虚拟机安装.html" class="sidebar-link">Linux虚拟机安装</a></li><li><a href="/md/DevOps/Linux/Linux-02-Linux虚拟网络.html" class="active sidebar-link">Linux虚拟网络</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/md/DevOps/Linux/Linux-02-Linux虚拟网络.html#network-namespace" class="sidebar-link">Network Namespace</a></li><li class="sidebar-sub-header"><a href="/md/DevOps/Linux/Linux-02-Linux虚拟网络.html#veth-pair" class="sidebar-link">veth pair</a></li><li class="sidebar-sub-header"><a href="/md/DevOps/Linux/Linux-02-Linux虚拟网络.html#网桥" class="sidebar-link">网桥</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="linux虚拟网络技术"><a href="#linux虚拟网络技术" class="header-anchor">#</a> Linux虚拟网络技术</h1> <p>由于作者最近在学习Docker网络，对Docker之间如何通信比较感兴趣，所以作为学习Docker网络的前置知识，我从网上查阅了资料并整理分享。</p> <p><a href="/md/DevOps/Docker/Docker理论知识/Docker-06-Docker网络.html">Docker网络</a></p> <h2 id="network-namespace"><a href="#network-namespace" class="header-anchor">#</a> Network Namespace</h2> <p>Network Namespace 是 Linux 内核提供的功能，是实现网络虚拟化的重要功能，它能创建多个隔离的网络空间，它们有独自网络栈信息。但是不同的Network Namespace之间是不能通信的，如下图所示：</p> <p><img src="/assets/img/image-20210202171922308.338766e3.png" alt="image-20210202171922308"></p> <h3 id="ip-netns命令"><a href="#ip-netns命令" class="header-anchor">#</a> ip netns命令</h3> <p>可以借助<code>ip netns</code>(netns可以理解为network namespace的缩写)命令来完成对 Network Namespace 的各种操作。<code>ip netns</code>命令来自于<code>iproute2</code>安装包，一般系统会默认安装，如果没有的话，读者自行安装。</p> <p>注意：<code>ip netns</code>命令修改网络配置时需要 sudo 权限。</p> <p>可以通过<code>ip netns</code>命令完成对Network Namespace 的相关操作，可以通过<code>ip netns help</code>查看命令帮助信息：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token builtin class-name">help</span>
Usage: <span class="token function">ip</span> netns list
       <span class="token function">ip</span> netns <span class="token function">add</span> NAME
       <span class="token function">ip</span> netns <span class="token builtin class-name">set</span> NAME NETNSID
       <span class="token function">ip</span> <span class="token punctuation">[</span>-all<span class="token punctuation">]</span> netns delete <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span>
       <span class="token function">ip</span> netns identify <span class="token punctuation">[</span>PID<span class="token punctuation">]</span>
       <span class="token function">ip</span> netns pids NAME
       <span class="token function">ip</span> <span class="token punctuation">[</span>-all<span class="token punctuation">]</span> netns <span class="token builtin class-name">exec</span> <span class="token punctuation">[</span>NAME<span class="token punctuation">]</span> cmd <span class="token punctuation">..</span>.
       <span class="token function">ip</span> netns monitor
       <span class="token function">ip</span> netns list-id
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>默认情况下，Linux系统中是没有任何 Network Namespace的，所以<code>ip netns list</code>命令不会返回任何信息。</p> <h3 id="创建network-namespace"><a href="#创建network-namespace" class="header-anchor">#</a> 创建Network Namespace</h3> <p>下面，我们通过命令创建一个名为<code>ns0</code>的命名空间：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token function">add</span> ns0
$ <span class="token function">ip</span> netns list
ns0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>新创建的 Network Namespace 会出现在<code>/var/run/netns/</code>目录下。如果相同名字的 namespace 已经存在，命令会报<code>Cannot create namespace file &quot;/var/run/netns/ns0&quot;: File exists</code>的错误。</p> <p>对于每个 Network Namespace 来说，它会有自己独立的网卡、路由表、ARP 表、iptables 等和网络相关的资源。</p> <h3 id="操作network-namespace"><a href="#操作network-namespace" class="header-anchor">#</a> 操作Network Namespace</h3> <p><code>ip</code>命令提供了<code>ip netns exec</code>子命令可以在对应的 Network Namespace 中执行命令。</p> <p>可以把新建的Network Namespace理解为一个空间，执行<code>ip netns exec</code>就相当于进入那个空间，然后后面再接对这个空间的操作的指令。比如：</p> <ol><li>查看新创建 Network Namespace 的网卡信息</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># ip netns exec ns0表示进入ns0的空间，ip addr表示查看该空间的网卡信息(旧命令的ifconfig)</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns0 <span class="token function">ip</span> addr
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noop state DOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看到，新创建的Network Namespace中会默认创建一个<code>lo</code>回环网卡，此时网卡处于<code>关闭</code>状态。此时，尝试去 ping 该<code>lo</code>回环网卡，会提示<code>Network is unreachable</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns0 <span class="token function">ping</span> <span class="token number">127.0</span>.0.1
connect: Network is unreachable
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>通过下面的命令启用<code>lo</code>回环网卡：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns0 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> lo up
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>然后再次尝试去 ping 该<code>lo</code>回环网卡：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#-c 3：指定了ping的包数为3</span>
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns0 <span class="token function">ping</span> -c <span class="token number">3</span> <span class="token number">127.0</span>.0.1
PING <span class="token number">127.0</span>.0.1 <span class="token punctuation">(</span><span class="token number">127.0</span>.0.1<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">127.0</span>.0.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.048</span> ms
<span class="token number">64</span> bytes from <span class="token number">127.0</span>.0.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.031</span> ms
<span class="token number">64</span> bytes from <span class="token number">127.0</span>.0.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.029</span> ms

--- <span class="token number">127.0</span>.0.1 <span class="token function">ping</span> statistics ---
<span class="token number">3</span> packets transmitted, <span class="token number">3</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 1999ms
rtt min/avg/max/mdev <span class="token operator">=</span> <span class="token number">0.029</span>/0.036/0.048/0.008 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="转移设备"><a href="#转移设备" class="header-anchor">#</a> 转移设备</h3> <p>我们可以在不同的 Network Namespace 之间转移设备（如veth）。由于一个设备只能属于一个 Network Namespace ，所以转移后在这个 Network Namespace 内就看不到这个设备了。</p> <p>其中，veth设备属于可转移设备，而很多其它设备（如lo、vxlan、ppp、bridge等）是不可以转移的。</p> <h2 id="veth-pair"><a href="#veth-pair" class="header-anchor">#</a> veth pair</h2> <p>veth pair 全称是 Virtual Ethernet Pair，是一个成对的端口，可以将两个Network Namespace 连接起来。如下图：</p> <p><img src="/assets/img/image-20210202102332707.31cd1502.png" alt="image-20210202102332707"></p> <h3 id="创建veth-pair"><a href="#创建veth-pair" class="header-anchor">#</a> 创建veth pair</h3> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">sudo</span> <span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> <span class="token builtin class-name">type</span> veth
$ <span class="token function">ip</span> addr
<span class="token number">61</span>: veth0@veth1: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,M-DOWN<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noop state DOWN group default qlen <span class="token number">1000</span>
    link/ether e6:39:e1:e0:3a:a0 brd ff:ff:ff:ff:ff:ff
<span class="token number">62</span>: veth1@veth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,M-DOWN<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noop state DOWN group default qlen <span class="token number">1000</span>
    link/ether be:41:49:42:23:6a brd ff:ff:ff:ff:ff:ff
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>可以看到，此时系统中新增了一对veth pair，将veth0和veth1两个虚拟网卡连接了起来，此时这对 veth pair 处于”未启用“状态。</p> <p>如果我们想指定 veth pair 两个端点的名称，可以使用下面的命令：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#可以理解为add一个叫vethfoo的网卡，类型的veth，他的另一半的名字叫vethbar</span>
<span class="token function">ip</span> <span class="token function">link</span> <span class="token function">add</span> vethfoo <span class="token builtin class-name">type</span> veth peer name vethbar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="实现network-namespace间通信"><a href="#实现network-namespace间通信" class="header-anchor">#</a> 实现Network Namespace间通信</h3> <p>下面我们利用veth pair实现两个不同的 Network Namespace 之间的通信。刚才我们已经创建了一个名为<code>ns0</code>的 Network Namespace，下面再创建一个信息Network Namespace，命名为<code>ns1</code></p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token function">add</span> ns1
$ <span class="token function">ip</span> netns list
ns1
ns0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>然后我们将veth0加入到ns0，将veth1加入到ns1，如下所示：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 设置网卡的Network Namespace</span>
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth0 netns ns0
$ <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth1 netns ns1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>查看ns0命名空间的网卡：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns0 <span class="token function">ip</span> addr
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span> 
       valid_lft forever preferred_lft forever
<span class="token number">28</span>: veth0@if29: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noop state DOWN group default qlen <span class="token number">1000</span>
    link/ether ba:80:f6:37:34:9f brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>可以看到空间里面的虚拟网卡veth0，他的状态是down。</p> <p>然后我们分别为这对veth pair配置上ip地址，并启用它们：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns0 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth0 up
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns0 <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.0</span>.1.1/24 dev veth0
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns1 <span class="token function">ip</span> <span class="token function">link</span> <span class="token builtin class-name">set</span> veth1 up
$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns1 <span class="token function">ip</span> addr <span class="token function">add</span> <span class="token number">10.0</span>.1.2/24 dev veth1
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>查看这对veth pair的状态</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns0 <span class="token function">ip</span> addr
<span class="token number">61</span>: veth0@if62: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state UP group default qlen <span class="token number">1000</span>
    link/ether e6:39:e1:e0:3a:a0 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">1</span>
    inet <span class="token number">10.0</span>.1.1/24 scope global veth0
       valid_lft forever preferred_lft forever
    inet6 fe80::e439:e1ff:fee0:3aa0/64 scope <span class="token function">link</span>
       valid_lft forever preferred_lft forever

$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns1 <span class="token function">ip</span> addr
<span class="token number">62</span>: veth1@if61: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state UP group default qlen <span class="token number">1000</span>
    link/ether be:41:49:42:23:6a brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">0</span>
    inet <span class="token number">10.0</span>.1.2/24 scope global veth1
       valid_lft forever preferred_lft forever
    inet6 fe80::bc41:49ff:fe42:236a/64 scope <span class="token function">link</span>
       valid_lft forever preferred_lft forever
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>从上面可以看出，我们已经成功启用了这个veth pair，并为每个veth设备分配了对应的ip地址。我们尝试在<code>ns1</code>中访问<code>ns0</code>中的ip地址：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns1 <span class="token function">ping</span> -c <span class="token number">3</span> <span class="token number">10.0</span>.1.1
sudo: unable to resolve <span class="token function">host</span> zormshogu
PING <span class="token number">10.0</span>.1.1 <span class="token punctuation">(</span><span class="token number">10.0</span>.1.1<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.1.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.091</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.1.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.035</span> ms
<span class="token number">64</span> bytes from <span class="token number">10.0</span>.1.1: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">3</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.037</span> ms

--- <span class="token number">10.0</span>.1.1 <span class="token function">ping</span> statistics ---
<span class="token number">3</span> packets transmitted, <span class="token number">3</span> received, <span class="token number">0</span>% packet loss, <span class="token function">time</span> 1999ms
rtt min/avg/max/mdev <span class="token operator">=</span> <span class="token number">0.035</span>/0.054/0.091/0.026 ms
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>可以看到，veth pair成功实现了两个不同Network Namespace之间的网络交互。</p> <h3 id="veth查看对端"><a href="#veth查看对端" class="header-anchor">#</a> veth查看对端</h3> <p>可以通过<code>ethtool</code>工具来查看（当Network Namespace很多时，操作会比较麻烦）：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns1 <span class="token function">ethtool</span> -S veth1
NIC statistics:
    peer_ifindex: <span class="token number">5</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>得知另一端的接口设备序列号是5，我们再到另一个命名空间中查看序列号5代表什么设备：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ <span class="token function">ip</span> netns <span class="token builtin class-name">exec</span> ns0 <span class="token function">ip</span> <span class="token function">link</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">5</span>
veth0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="网桥"><a href="#网桥" class="header-anchor">#</a> 网桥</h2> <p>veth pair有一个明显的缺陷，就是只能实现两个网络接口之间的通信。如果我们想实现多个网络接口之间的通信，就可以使用下面介绍的网桥（Bridge）技术。简单来说，网桥就是把一台机器上的若干个网络接口“连接”起来。</p> <h3 id="网桥的工作原理"><a href="#网桥的工作原理" class="header-anchor">#</a> 网桥的工作原理</h3> <p>网桥对报文的转发基于MAC地址。网桥能够解析收发的报文，读取目标MAC地址的信息，和自己记录的MAC表结合，来决策报文的转发目标网口。(类似交换机)</p> <p><img src="/assets/img/image-20210202155857416.cc069115.png" alt="image-20210202155857416"></p> <h3 id="网桥的实现"><a href="#网桥的实现" class="header-anchor">#</a> 网桥的实现</h3> <p>Linux内核是通过一个虚拟的网桥设备（Net Device）来实现桥接的。这个虚拟设备可以绑定若干个以太网接口设备，从而将它们桥接起来。如下图所示：</p> <p><img src="/assets/img/image-20210202160022920.e1bc8bde.png" alt="image-20210202160022920"></p> <p>如上图所示，网桥设备 br0 绑定了 eth0 和 eth1。</p> <p>对于网络协议栈的上层来说，只看得到 br0，上层协议栈需要发送的报文被送到 br0，网桥设备的处理代码判断报文该被转发到 eth0 还是 eth1，或者两者皆转发；反过来，从eth0 或 eth1 接收到的报文被提交给网桥的处理代码，在这里会判断报文应该被转发、丢弃还是提交到协议栈上层。</p> <h3 id="brctl"><a href="#brctl" class="header-anchor">#</a> brctl</h3> <p>和网桥有关的操作可以使用命令 brctl，这个命令来自 bridge-utils 这个包。</p> <p>创建网桥</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 创建网桥</span>
brctl addbr br0 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>删除网桥</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 删除网桥</span>
brctl delbr br0
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>绑定网口</p> <ol><li>建立一个逻辑网段之后，我们还需要为这个网段分配特定的端口。在Linux 中，一个端口实际上就是一个物理或虚拟网卡。而每个网卡的名称则分别为eth0 ，eth1 ，eth2 。我们需要把每个网卡一一和br0 这个网段联系起来，作为br0 中的一个端口。</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># 让eth0 成为br0 的一个端口</span>
brctl addif br0 eth0  
<span class="token comment"># 让eth1 成为br0 的一个端口</span>
brctl addif br0 eth1
<span class="token comment"># 让eth2 成为br0 的一个端口</span>
brctl addif br0 eth2
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><blockquote><p>参考文档：</p></blockquote> <p>https://www.jianshu.com/p/f86d4b88777d</p></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/caizongkai/vuepressDemo/edit/main/docs/md/DevOps/Linux/Linux-02-Linux虚拟网络.md" target="_blank" rel="noopener noreferrer">帮助我们改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.c0473f8a.js" defer></script><script src="/assets/js/5.5eab205c.js" defer></script>
  </body>
</html>
